{% extends 'layout/layout.html' %}
{% block title %}Product List{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-3xl font-semibold text-gray-900 mb-6 text-center">Products</h1>

    <!-- TailwindCSS grid system for responsiveness -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-3 gap-6 justify-center">
        {% if products %}
        {% for product in products %}
        <div class="bg-white p-4 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300">
            <a href="{% url 'product:product_detail' id=product.id slug=product.slug %}" class="block">
                <!-- Image handling with fallback if no image -->
                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}"
                    class="w-full h-48 object-cover rounded-t-lg mb-4">
                {% else %}
                <div class="w-full h-48 bg-gray-200 rounded-t-lg mb-4"></div>
                {% endif %}

                <!-- Product Title -->
                <h2 class="text-lg font-semibold text-gray-800">{{ product.name }}</h2>

                <!-- Product Description with truncation -->
                <p class="text-sm text-gray-600 mt-2">{{ product.description|truncatewords:20 }}</p>

                <!-- Price Section -->
                <div class="mt-4 flex justify-between items-center">
                    <span class="text-xl font-semibold text-gray-900">${{ product.price }}</span>
                </div>
            </a>

            <!-- Add to Cart Button -->
            <form data-product-id="{{ product.id }}" class="add-to-cart-form">
                {% csrf_token %}
                <button type="button"
                    class="mt-4 bg-blue-600 text-white py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300">
                    Add to Cart
                </button>
            </form>

        </div>
        {% endfor %}
        {% else %}
        <li class="text-center text-lg text-gray-600">No products found.</li>
        {% endif %}
    </div>
</div>
<script>

    document.addEventListener("DOMContentLoaded", function () {
        // Select all add-to-cart forms
        const addToCartForms = document.querySelectorAll(".add-to-cart-form");

        if (addToCartForms.length === 0) {
            console.error("No add-to-cart forms found.");
            return; // Exit early if no forms exist
        }

        // Iterate through forms and attach event listeners
        addToCartForms.forEach(form => {
            form.addEventListener("click", function (event) {
                event.preventDefault(); // Prevent default form submission

                const productId = form.getAttribute("data-product-id"); // Get product ID
                const csrfToken = getCookie("csrftoken"); // Fetch CSRF token

                if (!productId || !csrfToken) {
                    console.error("Missing product ID or CSRF token.");
                    return;
                }

                // Send AJAX request to add the product to the cart
                fetch(`/cart/add/${productId}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken
                    },
                    body: JSON.stringify({ product_id: productId })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Failed to add product.");
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            const cartCounter = document.getElementById("cart-counter");
                            if (cartCounter) {
                                cartCounter.innerText = data.cart_count;
                            }

                            const feedback = document.createElement("div");
                            feedback.innerText = "Product added!";
                            feedback.className = "text-green-600 mt-2 text-sm";
                            form.appendChild(feedback);

                            setTimeout(() => feedback.remove(), 3000);
                        } else {
                            alert(data.message || "Failed to add product to cart.");
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("An error occurred while adding the product to the cart.");
                    });
            });
        });

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    })
</script>


{% endblock %}