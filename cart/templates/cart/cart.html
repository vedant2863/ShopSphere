{% extends 'layout/layout.html' %}

{% block content %}
<div class="container mx-auto p-4">
    <h2 class="text-3xl font-bold mb-4 text-center">Your Shopping Cart</h2>

    {% if cart.cart_items.count == 0 %}
    <p class="text-center text-gray-600">Your cart is empty.</p>
    {% else %}
    <div class="flex flex-col space-y-6">
        {% for item in cart.cart_items.all %}
        <div
            class="flex flex-col md:flex-row items-center bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300">
            <!-- Product Image -->
            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}"
                class="w-32 h-32 object-cover rounded-lg mr-0 md:mr-6 mb-4 md:mb-0" />

            <!-- Product Details -->
            <div class="flex-1">
                <h3 class="text-xl font-semibold text-gray-900">{{ item.product.name }}</h3>
                <p class="text-sm text-gray-600">${{ item.product.price }}</p>
            </div>

            <!-- Quantity and Total -->
            <div class="flex items-center space-x-4">
                <!-- Quantity Input -->
                <div>
                    <label for="quantity-{{ item.id }}" class="sr-only">Quantity</label>
                    <input type="number" id="quantity-{{ item.id }}" name="quantity" value="{{ item.quantity }}" min="1"
                        class="border p-2 w-16 rounded-lg quantity-input" data-cart-item-id="{{ item.id }}" />
                </div>

                <!-- Total Price -->
                <p class="text-lg font-semibold text-gray-800" id="cart-item-total-{{ item.id }}">${{item.total_price}}</p>
            </div>

            <!-- Remove Button -->
            <div class="mt-4 md:mt-0">
                <a href="{% url 'cart:remove_from_cart' item.id %}" class="text-red-500 hover:text-red-700">Remove</a>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Total Cost Section -->
    <div class="mt-6 text-right">
        <p class="text-2xl font-bold text-gray-800">Cart Total: <span id="cart-total">${{ cart.total_cost }}</span></p>
    </div>

    <!-- Checkout Section -->
    <div class="mt-6 flex justify-center">
        <a class="bg-indigo-600 text-white py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors">Proceed to
            Checkout</a>
    </div>
    {% endif %}
</div>

<!-- JavaScript to auto-update the cart -->
<script>
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', function () {
            const cartItemId = this.dataset.cartItemId;
            const newQuantity = parseInt(this.value, 10);
            const csrfToken = getCookie('csrftoken');

            // Validate quantity client-side
            if (newQuantity < 1) {
                alert('Quantity must be at least 1');
                this.value = 1; // Reset to 1
                return;
            }

            // Display updating feedback
            const itemTotalElement = document.querySelector(`#cart-item-total-${cartItemId}`);
            const originalText = itemTotalElement.innerText;
            itemTotalElement.innerText = 'Updating...';

            // Perform AJAX request
            fetch(`/cart/update/ajax/${cartItemId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ quantity: newQuantity }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the totals on success
                        itemTotalElement.innerText = `$${data.total_price}`;
                        document.querySelector('#cart-total').innerText = `$${data.cart_total}`;
                    } else {
                        // Revert to original and alert on failure
                        itemTotalElement.innerText = originalText;
                        alert(data.message || 'Failed to update cart item quantity');
                    }
                })
                .catch(error => {
                    // Revert to original and alert on error
                    itemTotalElement.innerText = originalText;
                    alert('An error occurred while updating the cart');
                    console.error('Error:', error);
                });
        });
    });


    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}